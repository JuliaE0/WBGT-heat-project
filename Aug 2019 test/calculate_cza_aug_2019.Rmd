---
title: "calculate_cza"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, results='asis', message=FALSE, warning=FALSE, collapse=TRUE)
```

```{r}
library(heatmetrics)
ls("package:heatmetrics") # functions in the heatmetrics package
```

Data source:

Muñoz Sabater, J. (2019): ERA5-Land hourly data from 1950 to present. Copernicus Climate Change Service (C3S) Climate Data Store (CDS). DOI: 10.24381/cds.e2161bac (Accessed on 27-01-2026)

Hersbach, H., Bell, B., Berrisford, P., Biavati, G., Horányi, A., Muñoz Sabater, J., Nicolas, J., Peubey, C., Radu, R., Rozum, I., Schepers, D., Simmons, A., Soci, C., Dee, D., Thépaut, J-N. (2023): ERA5 hourly data on single levels from 1940 to present. Copernicus Climate Change Service (C3S) Climate Data Store (CDS), DOI: 10.24381/cds.adbb2d47 (Accessed on 27-01-2026)

```{r}
library(ncdf4)
library(terra)
```

```{r}
era5land <- nc_open("era5-land_2019.nc") # era5-land
names(era5land$var)

era5 <- nc_open("era5_2019.nc") # era5
names(era5$var)
```

```{r}
# open and view preprocessed dataset
wbgt_inputs_aug_2019 <- nc_open("wbgt_inputs_aug_2019.nc")
names(wbgt_inputs_aug_2019$var)
dim(ncvar_get(wbgt_inputs_aug_2019, "fdir")) # R shows dimensions as longitude x latitude x time
```

```{r}
# get inputs for calc_cza_int
lat <- ncvar_get(wbgt_inputs_aug_2019, "latitude")
lon <- ncvar_get(wbgt_inputs_aug_2019, "longitude")
year  <- ncvar_get(wbgt_inputs_aug_2019, "year")
month <- ncvar_get(wbgt_inputs_aug_2019, "month")
day   <- ncvar_get(wbgt_inputs_aug_2019, "day")
hour  <- ncvar_get(wbgt_inputs_aug_2019, "hour")

# expand to full grid
grid <- expand.grid(lon = lon, lat = lat, t = seq_along(year))
grid$y   <- year[grid$t]
grid$mon <- month[grid$t]
grid$d   <- day[grid$t]
grid$hr  <- hour[grid$t]

# call calc_cza_int() ---- takes about 10 minutes
cza <- calc_cza_int(grid$lat, grid$lon, grid$y, grid$mon, grid$d, grid$hr)

# reshape back to 3-dimensional array
ntime <- length(year)
nlat <- length(lat)
nlon <- length(lon)

cza_array <- array(cza, dim = c(nlon, nlat, ntime))
```

```{r}
# check that dimensions of cza_array match dimensions of wbgt_inputs_aug_2019
dim(ncvar_get(wbgt_inputs_aug_2019, "solar"))
dim(cza_array)  # longitude x latitude x time

summary(cza_array) # check that all values are in [0,1]
```

```{r}
# crop cza_array to California shape

cza_array_for_terra <- aperm(cza_array, c(2,1,3)) # latitude x longitude x time ordering for terra
r_cza <- rast(cza_array_for_terra) # convert array to raster
ext(r_cza) <- c(min(lon), max(lon), min(lat), max(lat))
crs(r_cza) <- "EPSG:4326"
ca <- vect("ca_state/CA_State.shp")
ca <- project(ca, crs(r_cza))
r_cza_ca <- crop(r_cza, ca, snap="out") # crop with whole grid cells on CA boundary
r_cza_ca <- mask(r_cza_ca, ca)

# convert raster in the shape of CA back to array
cza_array_ca <- as.array(r_cza_ca)
cza_array_ca <- aperm(cza_array_ca, c(2,1,3)) # reorder back to longitude x latitude x time

dim(cza_array_ca) # check dimensions of cropped array
```

```{r}
# check that cza_array_ca is actually cropped to CA by plotting it

times <- as.POSIXct(ncvar_get(wbgt_inputs_aug_2019, "valid_time"), origin = "1970-01-01", tz = "UTC")
t_index <- which(times == as.POSIXct("2019-08-01 18:00", tz="UTC"))
r_cza_ca <- rast(aperm(cza_array_ca, c(2,1,3)))
ext(r_cza_ca) <- c(min(lon), max(lon), min(lat), max(lat))
crs(r_cza_ca) <- "EPSG:4326"
plot(r_cza_ca[[t_index]])
title(main = paste("cza at", times[t_index]), line=3)
```

```{r}
# put cza_array_ca into wbgt_inputs_aug_2019 as a variable -- edited wbgt_inputs_aug_2019 directly

nc_close(wbgt_inputs_aug_2019)

wbgt_inputs_aug_2019 <- nc_open("wbgt_inputs_aug_2019.nc", write = TRUE)

dim_lon  <- wbgt_inputs_aug_2019$dim$longitude
dim_lat  <- wbgt_inputs_aug_2019$dim$latitude
dim_time <- wbgt_inputs_aug_2019$dim$valid_time

cza <- ncvar_def(
  name = "cza",
  units = "",   # no units because it's a ratio
  dim = list(dim_lon, dim_lat, dim_time),
  missval = -9999,
  longname = "cosine solar zenith angle (0-1)",
  prec = "float"
)

wbgt_inputs_aug_2019 <- ncvar_add(wbgt_inputs_aug_2019, cza)

ncvar_put(wbgt_inputs_aug_2019, cza, cza_array_ca)

nc_close(wbgt_inputs_aug_2019)
```

```{r}
# check wbgt_inputs_aug_2019

wbgt_inputs_aug_2019 <- nc_open("wbgt_inputs_aug_2019.nc")
names(wbgt_inputs_aug_2019$var)
dim(ncvar_get(wbgt_inputs_aug_2019, "fdir")) # R shows dimensions as longitude x latitude x time
```

```{r}
# just checking
# plot with wbgt_inputs_aug_2019 Tair variable at a single valid_time

r <- rast("wbgt_inputs_aug_2019.nc", subds = "Tair")
time_raw <- ncvar_get(wbgt_inputs_aug_2019, "valid_time")
time_units <- ncatt_get(wbgt_inputs_aug_2019, "valid_time", "units")$value
time_vals <- as.POSIXct(time_raw, origin="1970-01-01", tz="UTC")
time(r) <- time_vals
t_index <- which(time_vals == as.POSIXct("2019-08-01 18:00", tz="UTC"))
plot(r[[t_index]])
title(main = "Tair at 2019-08-01 18:00", line=3)
```


