---
title: "correlation with wbgt"
output: html_document
date: "2026-02-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ncdf4)
library(terra)
library(parallel)
```

```{r}
# open wbgt_aug_2019.nc
wbgt_aug_2019 <- nc_open("wbgt_aug_2019.nc")
names(wbgt_aug_2019$var)
dim(ncvar_get(wbgt_aug_2019, "wbgt")) # R shows dimensions as longitude x latitude x time
```

```{r}
# open wbgt_inputs_aug_2019.nc
wbgt_inputs_aug_2019 <- nc_open("wbgt_inputs_aug_2019.nc")
names(wbgt_inputs_aug_2019$var)
dim(ncvar_get(wbgt_inputs_aug_2019, "fdir")) # R shows dimensions as longitude x latitude x time
```

```{r}
# plot with wet-bulb globe temp at a single valid_time
times <- as.POSIXct(ncvar_get(wbgt_aug_2019, "valid_time"), origin = "1970-01-01", tz = "UTC")
t_index <- which(times == as.POSIXct("2019-08-01 18:00", tz="UTC"))
r <- rast("wbgt_aug_2019.nc", subds = "wbgt")
plot(r[[t_index]])
title(main = paste("wbgt at", times[t_index]), line=3)

# plot dry-bulb air temperature at a single valid_time
times <- as.POSIXct(ncvar_get(wbgt_inputs_aug_2019, "valid_time"), origin = "1970-01-01", tz = "UTC")
t_index <- which(times == as.POSIXct("2019-08-01 18:00", tz="UTC"))
r <- rast("wbgt_inputs_aug_2019.nc", subds = "Tair")
plot(r[[t_index]])
title(main = paste("dry-bulb air temp at", times[t_index]), line=3)
```

```{r}
# overall correlation

wbgt <- ncvar_get(wbgt_aug_2019, "wbgt")
atemp <- ncvar_get(wbgt_inputs_aug_2019, "Tair")

dim(wbgt)
dim(atemp)  # dimensions are longitude x latitude x time

cor(as.vector(wbgt), as.vector(atemp), use = "complete.obs")
```

```{r}
# per-location correlation over time

nlon  <- dim(atemp)[1]
nlat  <- dim(atemp)[2]
ntime <- dim(atemp)[3]

atemp_mat <- matrix(aperm(atemp, c(3,1,2)), nrow = ntime)
wbgt_mat <- matrix(aperm(wbgt, c(3,1,2)), nrow = ntime)

cor_vals <- sapply(
  1:ncol(atemp_mat),
  function(k)
    cor(atemp_mat[,k],
        wbgt_mat[,k],
        use = "complete.obs")
)

cor_map <- array(cor_vals, dim = c(nlon, nlat))


r_cor <- rast(t(cor_map))
ext(r_cor) <- c(min(lon), max(lon), min(lat), max(lat))
crs(r_cor) <- "EPSG:4326"

plot(r_cor)


```


