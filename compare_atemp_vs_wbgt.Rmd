---
title: "correlation with wbgt"
output: html_document
date: "2026-02-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ncdf4)
library(terra)
library(parallel)
```

```{r}
# open wbgt_aug_2019.nc
wbgt_aug_2019 <- nc_open("wbgt_aug_2019.nc")
names(wbgt_aug_2019$var)
dim(ncvar_get(wbgt_aug_2019, "wbgt")) # R shows dimensions as longitude x latitude x time
```

```{r}
# open wbgt_inputs_aug_2019.nc
wbgt_inputs_aug_2019 <- nc_open("wbgt_inputs_aug_2019.nc")
names(wbgt_inputs_aug_2019$var)
dim(ncvar_get(wbgt_inputs_aug_2019, "Tair")) # R shows dimensions as longitude x latitude x time
```

```{r}
times <- as.POSIXct(ncvar_get(wbgt_aug_2019, "valid_time"), origin = "1970-01-01", tz = "UTC")
t_index <- which(times == as.POSIXct("2019-08-01 18:00", tz="UTC"))

# plot with wet-bulb globe temp at a single valid_time
r <- rast("wbgt_aug_2019.nc", subds = "wbgt")
plot(r[[t_index]])
title(main = paste("wbgt at", times[t_index]), line=3)

# plot dry-bulb air temperature at a single valid_time
r <- rast("wbgt_inputs_aug_2019.nc", subds = "Tair")
plot(r[[t_index]])
title(main = paste("dry-bulb air temp at", times[t_index]), line=3)
```

```{r}
# overall correlation

wbgt <- ncvar_get(wbgt_aug_2019, "wbgt")
atemp <- ncvar_get(wbgt_inputs_aug_2019, "Tair")

cor(as.vector(wbgt), as.vector(atemp), use = "complete.obs")
```

```{r}
# spatial correlation at each hour

nlon  <- dim(atemp)[1]  # 105
nlat  <- dim(atemp)[2]  # 96
ntime <- dim(atemp)[3]  # 744

lon <- ncvar_get(wbgt_inputs_aug_2019, "longitude")
lat <- ncvar_get(wbgt_inputs_aug_2019, "latitude")

cor_time <- sapply(
  1:ntime,
  function(t)
    cor(as.vector(atemp[,,t]),
        as.vector(wbgt[,,t]),
        use="complete.obs"))

time_seq <- seq(as.POSIXct("2019-08-01 00:00", tz="UTC"), by = "hour", length.out = ntime)

# correlation during daytime higher than during nighttime
hours <- as.integer(format(time_seq, "%H"))
day_cor   <- cor_time[hours >= 13 & hours <= 23]
night_cor <- cor_time[hours <= 13]
print(paste("daytime (hr 13-23) correlation:", mean(day_cor)))
print(paste("nighttime (hr 0-13) correlation", mean(night_cor)))

# time series over entire Aug 2019, hourly
par(mar = c(5, 5, 1, 0)) 
plot(cor_time, type="l",
     ylab="Spatial correlation \n bewteen dry-bulb air temp and WBGT",
     xlab="Time index")

# time series over one week
start_time <- as.POSIXct("2019-08-01 00:00", tz="UTC")
end_time   <- start_time + 168*3600
idx <- which(time_seq >= start_time & time_seq < end_time)
par(mar = c(5, 5, 1, 0)) 
plot(time_seq[idx],
     cor_time[idx],
     type="l",
     ylab="Spatial correlation \n bewteen dry-bulb air temp and WBGT",
     xlab="Date")

# time series over two days
start_time <- as.POSIXct("2019-08-01 00:00", tz="UTC")
end_time   <- start_time + 48*3600
idx <- which(time_seq >= start_time & time_seq < end_time)
par(mar = c(5, 5, 1, 0)) 
plot(time_seq[idx],
     cor_time[idx],
     type="l",
     ylab="Spatial correlation \n bewteen dry-bulb air temp and WBGT",
     xlab="Date")

# mean correlation over a day
hour_all <- as.integer(format(time_seq, "%H"))

mean_by_hour <- tapply(cor_time, hour_all, mean, na.rm=TRUE)

plot(0:23, mean_by_hour, type="l",
     xlab="Hour of day",
     ylab="Mean spatial correlation")
```
These time series shows how the spatial relationship between dry-bulb air temp and wbgt changes over time.

WBGT spatial patterns follow dry-bulb air temperature more strongly during daytime (higher correlation) and diverge more at night (lower correlation). 

```{r}
# correlation across time at each grid cell

nlon  <- dim(atemp)[1]
nlat  <- dim(atemp)[2]
ntime <- dim(atemp)[3]

atemp_mat <- matrix(aperm(atemp, c(3,1,2)), nrow = ntime)
wbgt_mat <- matrix(aperm(wbgt, c(3,1,2)), nrow = ntime)

cor_vals <- sapply(
  1:ncol(atemp_mat),
  function(k)
    cor(atemp_mat[,k],
        wbgt_mat[,k]))

cor_map <- array(cor_vals, dim = c(nlon, nlat))

r_cor <- rast(t(cor_map))
ext(r_cor) <- c(min(lon), max(lon), min(lat), max(lat))
crs(r_cor) <- "EPSG:4326"


plot(r_cor, main = "Temporal Correlation Between Air Temperature and WBGT \n (August 2019)",
     cex.main=0.9)
usr <- par("usr")
text(
  x = usr[2],                     # just right of legend
  y = mean(usr[3:4]),
  labels = "Pearson correlation coefficient",
  srt = 90,
  xpd = NA,
  cex = 0.9)
```
The color of each grid cell represents the temporal Pearson correlation between dry-bulb air temp and WBGT across hourly timesteps in August 2019. High correlation seems to be seen inland and in the hotter regions of California. Lower correlation is seen on the coast and mountains.

