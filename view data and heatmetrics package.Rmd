---
title: "Data"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, results='asis', message=FALSE, warning=FALSE, collapse=TRUE)
```

```{r}
library(heatmetrics)
ls("package:heatmetrics") # functions in the heatmetrics package
```

Data source:

Muñoz Sabater, J. (2019): ERA5-Land hourly data from 1950 to present. Copernicus Climate Change Service (C3S) Climate Data Store (CDS). DOI: 10.24381/cds.e2161bac (Accessed on 27-01-2026)

Hersbach, H., Bell, B., Berrisford, P., Biavati, G., Horányi, A., Muñoz Sabater, J., Nicolas, J., Peubey, C., Radu, R., Rozum, I., Schepers, D., Simmons, A., Soci, C., Dee, D., Thépaut, J-N. (2023): ERA5 hourly data on single levels from 1940 to present. Copernicus Climate Change Service (C3S) Climate Data Store (CDS), DOI: 10.24381/cds.adbb2d47 (Accessed on 27-01-2026)


```{r}
library(ncdf4)
library(terra)
```


```{r}
era5land <- nc_open("era5-land_2019.nc") # era5-land
names(era5land$var)

era5 <- nc_open("era5_2019.nc") # era5
names(era5$var)
```


```{r}
# preprocessed dataset (doesn't have urban variable yet)
ds_work <- nc_open("ds_work.nc")
names(ds_work$var)
dim(ncvar_get(ds_work, "fdir")) # view dimensions, R shows dimensions as longitude x latitude x time
```


```{r}
# get inputs for calc_cza_int
lat <- ncvar_get(ds_work, "latitude")
lon <- ncvar_get(ds_work, "longitude")
year  <- ncvar_get(ds_work, "year")
month <- ncvar_get(ds_work, "month")
day   <- ncvar_get(ds_work, "day")
hour  <- ncvar_get(ds_work, "hour")

# expand to full grid
grid <- expand.grid(t = seq_along(year), lat = lat, lon = lon)
grid$y   <- year[grid$t]
grid$mon <- month[grid$t]
grid$d   <- day[grid$t]
grid$hr  <- hour[grid$t]

# call calc_cza_int()
cza <- calc_cza_int(grid$lat, grid$lon, grid$y, grid$mon, grid$d, grid$hr)

# reshape back to 3-dimensional array
ntime <- length(year)
nlat <- length(lat)
nlon <- length(lon)

cza_array <- array(cza, dim = c(ntime, nlat, nlon))
```


```{r}
# check structure of cza_array

dim(cza_array)  # should be time=744, latitude=96, longitude=105
summary(cza_array) # check that all values are in [0,1]
```


```{r}
# crop cza_array to California shape

cza_array_for_terra <- aperm(cza_array, c(2,3,1)) # latitude x longitude x time ordering for terra
r_cza <- rast(cza_array_for_terra) # convert array to raster
ext(r_cza) <- c(min(lon), max(lon), min(lat), max(lat))
crs(r_cza) <- "EPSG:4326"
ca <- vect("ca_state/CA_State.shp")
ca <- project(ca, crs(r_cza))
r_cza_ca <- crop(r_cza, ca, snap="out") # crop with whole grid cells on CA boundary
r_cza_ca <- mask(r_cza_ca, ca)

# convert raster in the shape of CA back to array
cza_array_ca <- as.array(r_cza_ca)
cza_array_ca <- aperm(cza_array_ca, c(3,1,2)) # reorder back to time x latitude x longitude

dim(cza_array_ca) # check dimensions of cropped array

#plot_time <- as.POSIXct(ncvar_get(ds_work, "valid_time")[20], origin = "1970-01-01", tz = "UTC")
#plot(r_cza_ca[[20]])  # TO DO: plot using the cropped array
#title(main = paste("cza at", plot_time), line=3)
```


```{r}
# check that cza_array_ca is actually cropped to CA by plotting it

times <- as.POSIXct(ncvar_get(ds_work, "valid_time"), origin = "1970-01-01", tz = "UTC")
t_index <- which(times == as.POSIXct("2019-08-01 18:00", tz="UTC"))
r_cza_ca <- rast(aperm(cza_array_ca, c(2,3,1)))
ext(r_cza_ca) <- c(min(lon), max(lon), min(lat), max(lat))
crs(r_cza_ca) <- "EPSG:4326"
plot(r_cza_ca[[t_index]])
title(main = paste("cza at", times[t_index]), line=3)
```


```{r}
# just checking
# plot with ds_work solar variable at a single valid_time

r <- rast("ds_work.nc", subds = "solar")
time_raw <- ncvar_get(ds_work, "valid_time")
time_units <- ncatt_get(ds_work, "valid_time", "units")$value
time_vals <- as.POSIXct(time_raw, origin="1970-01-01", tz="UTC")
time(r) <- time_vals
t_index <- which(time_vals == as.POSIXct("2019-08-01 12:00", tz="UTC"))
plot(r[[t_index]])
title(main = "solar at 2019-08-01 12:00", line=3)
```


```{r}
# possibly put cza_array_ca into ds_work as a variable
```


